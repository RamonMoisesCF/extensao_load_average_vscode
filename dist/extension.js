"use strict";var F=Object.create;var O=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var b=Object.getPrototypeOf,C=Object.prototype.hasOwnProperty;var P=(o,s)=>{for(var n in s)O(o,n,{get:s[n],enumerable:!0})},$=(o,s,n,r)=>{if(s&&typeof s=="object"||typeof s=="function")for(let a of R(s))!C.call(o,a)&&a!==n&&O(o,a,{get:()=>s[a],enumerable:!(r=T(s,a))||r.enumerable});return o};var I=(o,s,n)=>(n=o!=null?F(b(o)):{},$(s||!o||!o.__esModule?O(n,"default",{value:o,enumerable:!0}):n,o)),x=o=>$(O({},"__esModule",{value:!0}),o);var y={};P(y,{activate:()=>N});module.exports=x(y);var e=I(require("vscode")),i=I(require("fs")),l=I(require("path")),f=I(require("os")),E=require("child_process"),w=null,D="",d,t={intervalSeconds:30,threshold:4,logFilePath:l.join(f.homedir(),"load_alerts.log"),showSidebar:!0};function N(o){console.log("[LOAD MONITOR] Ativando extens\xE3o..."),L(),t.showSidebar&&(d=e.window.createStatusBarItem(e.StatusBarAlignment.Right,100),d.text="Load: --",d.tooltip="Monitor de Load Average",d.show()),i.existsSync(t.logFilePath)||e.window.showWarningMessage(`Arquivo de log n\xE3o encontrado em: ${t.logFilePath}. Deseja gerar o script automaticamente para come\xE7ar a monitorar o sistema?`,"Gerar script","Cancelar").then(r=>{r==="Gerar script"&&A(t.logFilePath,t.threshold,t.intervalSeconds)});let s=()=>{if(!i.existsSync(t.logFilePath)){d&&(d.text="Load: arquivo n\xE3o encontrado");return}let a=i.readFileSync(t.logFilePath,"utf8").trim().split(`
`).reverse(),h=a.find(p=>p.includes("[ALERTA]")),u=a.find(p=>p.includes("[DEBUG]")),g=p=>{let M=p.match(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/);return M?M[0]:""},c=h||u||"";if(h&&u&&(c=new Date(g(h))>new Date(g(u))?h:u),!c){d&&(d.text="Load: --",d.backgroundColor=void 0);return}let m=c.match(/LOAD=(\d+(\.\d+)?)/)||c.match(/Load average alto: (\d+(\.\d+)?)/),v=m?parseFloat(m[1]):0;d&&(d.text=`Load: ${v.toFixed(2)}`,d.backgroundColor=v>t.threshold?new e.ThemeColor("statusBarItem.errorBackground"):void 0),c.includes("[ALERTA]")&&g(c)!==D&&v>t.threshold&&(D=g(c),e.window.showErrorMessage(`ALERTA: Load average alto: ${v}`))};(()=>{w&&clearInterval(w),w=setInterval(s,t.intervalSeconds*1e3),s()})(),e.workspace.onDidChangeConfiguration(r=>{r.affectsConfiguration("loadMonitor")&&(e.window.showInformationMessage("[LOAD MONITOR] Configura\xE7\xE3o alterada, reiniciando o script..."),S())}),o.subscriptions.push(e.commands.registerCommand("load-monitor-alert.runSetup",()=>{e.window.showInformationMessage("[LOAD MONITOR] Executando setup manual do script."),A(t.logFilePath,t.threshold,t.intervalSeconds)})),o.subscriptions.push(e.commands.registerCommand("load-monitor-alert.forceCheck",()=>{e.window.showInformationMessage("[LOAD MONITOR] For\xE7ando verifica\xE7\xE3o manual..."),L()})),o.subscriptions.push(e.commands.registerCommand("load-monitor-alert.cleanup",()=>{e.window.showInformationMessage("[LOAD MONITOR] Encerrando processo e limpando arquivos..."),S()})),o.subscriptions.push(e.commands.registerCommand("load-monitor-alert.reloadSettings",()=>{e.window.showInformationMessage("[LOAD MONITOR] Recarregando configura\xE7\xF5es..."),L(),S()})),o.subscriptions.push(e.commands.registerCommand("load-monitor-alert.showLog",()=>{L(),i.existsSync(t.logFilePath)?e.workspace.openTextDocument(t.logFilePath).then(r=>{e.window.showTextDocument(r)}):e.window.showInformationMessage("Arquivo de log n\xE3o encontrado.")})),o.subscriptions.push({dispose:()=>w&&clearInterval(w)}),o.subscriptions.push({dispose:()=>d?.dispose()})}function k(o){return o.startsWith("~")?l.join(f.homedir(),o.slice(1)):o}function L(){let o=e.workspace.getConfiguration("loadMonitor",null);t.intervalSeconds=o.get("intervalSeconds",30),t.threshold=o.get("threshold",4),t.logFilePath=k(o.get("logFilePath",l.join(f.homedir(),"load_alerts.log"))),t.showSidebar=o.get("showSidebar",!0),e.window.showInformationMessage(`[LOAD MONITOR] Configura\xE7\xF5es atualizadas: intervalo=${t.intervalSeconds}s, threshold=${t.threshold}, log=${t.logFilePath}`)}function A(o,s,n,r=!1){let a=l.join(f.homedir(),"load-monitor"),h=l.join(a,"monitor_load.sh"),u=l.join(a,"monitor_load.pid");i.existsSync(a)||i.mkdirSync(a,{recursive:!0});let g=`#!/bin/bash
THRESHOLD=${s}
INTERVAL=${n}
LOGFILE=${o}
MAX_SIZE=51200

export LC_NUMERIC=C
mkdir -p "$(dirname "$LOGFILE")"
echo "[INFO] Monitoramento de load iniciado: $(date)" >> "$LOGFILE"

while true; do
    if [ -f "$LOGFILE" ] && [ $(stat -c%s "$LOGFILE") -gt $MAX_SIZE ]; then
        echo "[INFO] $(date) - Log truncado por atingir limite de $MAX_SIZE bytes." > "$LOGFILE"
    fi

    RAW_LOAD=$(cut -d ' ' -f1 /proc/loadavg)
    LOAD=$(echo "$RAW_LOAD" | sed 's/,/./')

    TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[DEBUG] $TIMESTAMP - LOAD=$LOAD THRESHOLD=$THRESHOLD" >> "$LOGFILE"

    if (( $(echo "$LOAD > $THRESHOLD" | bc -l) )); then
        echo "[ALERTA] $TIMESTAMP - Load average alto: $LOAD" >> "$LOGFILE"
    fi

    sleep $INTERVAL
done
`;i.writeFileSync(h,g,{mode:493});let c=()=>{let m=(0,E.spawn)("bash",[h],{detached:!0,stdio:"ignore"});i.writeFileSync(u,String(m.pid),"utf-8"),m.unref(),e.window.showInformationMessage(`[LOAD MONITOR] Script monitor_load.sh iniciado com PID ${m.pid}`)};r?c():e.window.showInformationMessage(`Script gerado em ${h}. Deseja execut\xE1-lo?`,"Executar","Cancelar").then(m=>{m==="Executar"&&c()})}function S(){let o=l.join(f.homedir(),"load-monitor"),s=l.join(o,"monitor_load.pid");if(i.existsSync(s)){let n=i.readFileSync(s,"utf8").trim();try{process.kill(Number(n),"SIGTERM"),i.unlinkSync(s),e.window.showInformationMessage(`[LOAD MONITOR] Processo antigo encerrado (PID: ${n}).`)}catch(r){e.window.showWarningMessage(`[LOAD MONITOR] Falha ao encerrar o processo anterior: ${r}`)}}L(),A(t.logFilePath,t.threshold,t.intervalSeconds,!0)}0&&(module.exports={activate});
