"use strict";var M=Object.create;var w=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var T=Object.getOwnPropertyNames;var R=Object.getPrototypeOf,P=Object.prototype.hasOwnProperty;var C=(o,i)=>{for(var a in i)w(o,a,{get:i[a],enumerable:!0})},F=(o,i,a,d)=>{if(i&&typeof i=="object"||typeof i=="function")for(let r of T(i))!P.call(o,r)&&r!==a&&w(o,r,{get:()=>i[r],enumerable:!(d=D(i,r))||d.enumerable});return o};var A=(o,i,a)=>(a=o!=null?M(R(o)):{},F(i||!o||!o.__esModule?w(a,"default",{value:o,enumerable:!0}):a,o)),x=o=>F(w({},"__esModule",{value:!0}),o);var _={};C(_,{activate:()=>y,deactivate:()=>j});module.exports=x(_);var t=A(require("vscode")),s=A(require("fs")),c=A(require("path")),p=A(require("os")),$=require("child_process"),f=null,O="",n,e={intervalSeconds:30,threshold:4,logFilePath:c.join(p.homedir(),"load_alerts.log"),showSidebar:!0};function y(o){console.log("[LOAD MONITOR] Ativando extens\xE3o..."),b(),t.window.showInformationMessage("Load Monitor: iniciado."),e.showSidebar&&(n=t.window.createStatusBarItem(t.StatusBarAlignment.Right,100),n.text="Load: --",n.tooltip="Monitor de Load Average",n.show()),s.existsSync(e.logFilePath)||t.window.showWarningMessage(`Arquivo de log n\xE3o encontrado em: ${e.logFilePath}. Deseja gerar o script automaticamente para come\xE7ar a monitorar o sistema?`,"Gerar script","Cancelar").then(d=>{d==="Gerar script"&&I(e.logFilePath,e.threshold,e.intervalSeconds)});let i=()=>{if(console.log("[LOAD MONITOR] Verificando log..."),!s.existsSync(e.logFilePath)){console.log("[LOAD MONITOR] Arquivo de log n\xE3o encontrado. Abortando."),n&&(n.text="Load: arquivo n\xE3o encontrado");return}let r=s.readFileSync(e.logFilePath,"utf8").trim().split(`
`).reverse(),h=r.find(g=>g.includes("[ALERTA]")),m=r.find(g=>g.includes("[DEBUG]")),l="",S="",u=g=>{let v=g.match(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/);return v?v[0]:""};if(h&&m){let g=u(h),v=u(m);l=new Date(g)>new Date(v)?h:m}else l=h||m||"";if(!l){n&&(n.text="Load: --",n.backgroundColor=void 0);return}let E=l.match(/LOAD=(\d+(\.\d+)?)/)||l.match(/Load average alto: (\d+(\.\d+)?)/),L=E?parseFloat(E[1]):0;n&&(n.text=`Load: ${L.toFixed(2)}`,n.backgroundColor=L>e.threshold?new t.ThemeColor("statusBarItem.errorBackground"):void 0),l.includes("[ALERTA]")&&u(l)!==O&&L>e.threshold&&(O=u(l),t.window.showErrorMessage(`ALERTA: Load average alto: ${L}`))},a=()=>{f&&clearInterval(f),f=setInterval(i,e.intervalSeconds*1e3),i()};a(),t.workspace.onDidChangeConfiguration(d=>{if(d.affectsConfiguration("loadMonitor")){let r={...e};b();let h=e.logFilePath!==r.logFilePath,m=e.threshold!==r.threshold,l=e.intervalSeconds!==r.intervalSeconds;e.showSidebar!==r.showSidebar&&(e.showSidebar&&!n?(n=t.window.createStatusBarItem(t.StatusBarAlignment.Right,100),n.tooltip="Monitor de Load Average",n.show()):!e.showSidebar&&n&&(n.dispose(),n=void 0)),(m||l||h)&&k(),a()}}),o.subscriptions.push({dispose:()=>f&&clearInterval(f)}),o.subscriptions.push({dispose:()=>n?.dispose()}),o.subscriptions.push(t.commands.registerCommand("load-monitor-alert.runSetup",()=>{I(e.logFilePath,e.threshold,e.intervalSeconds)})),o.subscriptions.push(t.commands.registerCommand("load-monitor-alert.forceCheck",()=>{t.window.showInformationMessage("For\xE7ando verifica\xE7\xE3o manual do log..."),i()})),o.subscriptions.push(t.commands.registerCommand("load-monitor-alert.cleanup",()=>{t.window.showWarningMessage("Deseja parar o monitoramento e excluir os arquivos gerados?","Sim","Cancelar").then(d=>{if(d==="Sim"){let r=c.join(p.homedir(),"load-monitor"),h=c.join(r,"monitor_load.sh"),m=c.join(r,"monitor_load.pid");if(s.existsSync(e.logFilePath)&&s.unlinkSync(e.logFilePath),s.existsSync(h)&&s.unlinkSync(h),s.existsSync(m)){let l=s.readFileSync(m,"utf8").trim();try{process.kill(Number(l),"SIGTERM")}catch(S){console.error("Erro ao encerrar processo:",S)}s.unlinkSync(m)}t.window.showInformationMessage("Arquivos removidos com sucesso.")}})}))}function I(o,i,a,d=!1){let r=c.join(p.homedir(),"load-monitor"),h=c.join(r,"monitor_load.sh"),m=c.join(r,"monitor_load.pid");s.existsSync(r)||s.mkdirSync(r,{recursive:!0});let l=`#!/bin/bash
THRESHOLD=${i}
INTERVAL=${a}
LOGFILE="${o}"
MAX_SIZE=51200

export LC_NUMERIC=C
mkdir -p "$(dirname "$LOGFILE")"
echo "[INFO] Monitoramento de load iniciado: $(date)" >> "$LOGFILE"

while true; do
    if [ -f "$LOGFILE" ] && [ $(stat -c%s "$LOGFILE") -gt $MAX_SIZE ]; then
        echo "[INFO] $(date) - Log truncado por atingir limite de $MAX_SIZE bytes." > "$LOGFILE"
    fi

    RAW_LOAD=$(cut -d ' ' -f1 /proc/loadavg)
    LOAD=$(echo "$RAW_LOAD" | sed 's/,/./')

    TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[DEBUG] $TIMESTAMP - LOAD=$LOAD THRESHOLD=$THRESHOLD" >> "$LOGFILE"

    if (( $(echo "$LOAD > $THRESHOLD" | bc -l) )); then
        echo "[ALERTA] $TIMESTAMP - Load average alto: $LOAD" >> "$LOGFILE"
    fi

    sleep $INTERVAL
done
`;s.writeFileSync(h,l,{mode:493});let S=()=>{let u=(0,$.spawn)("bash",[h],{detached:!0,stdio:"ignore"});s.writeFileSync(m,String(u.pid),"utf-8"),u.unref(),t.window.showInformationMessage("Script de monitoramento reiniciado.")};d?S():t.window.showInformationMessage(`Script gerado com sucesso em: ${h}. Deseja execut\xE1-lo agora em background?`,"Executar","Cancelar").then(u=>{u==="Executar"&&S()})}function j(){f&&clearInterval(f);let o=c.join(p.homedir(),"load-monitor"),i=c.join(p.homedir(),"load_alerts.log"),a=c.join(o,"monitor_load.sh"),d=c.join(o,"monitor_load.pid")}function b(){let o=t.workspace.getConfiguration("loadMonitor");e.intervalSeconds=o.get("intervalSeconds",30),e.threshold=o.get("threshold",4),e.logFilePath=o.get("logFilePath",c.join(p.homedir(),"load_alerts.log")),e.showSidebar=o.get("showSidebar",!0)}function k(){let o=c.join(p.homedir(),"load-monitor"),i=c.join(o,"monitor_load.pid");if(s.existsSync(i)){let a=s.readFileSync(i,"utf8").trim();try{process.kill(Number(a),"SIGTERM"),s.unlinkSync(i),console.log(`[LOAD MONITOR] Processo antigo encerrado (PID: ${a}).`)}catch(d){console.error("[LOAD MONITOR] Erro ao encerrar processo antigo:",d)}}I(e.logFilePath,e.threshold,e.intervalSeconds,!0)}0&&(module.exports={activate,deactivate});
